<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Chapter 9. Extending and using GHC as a Library</title><link rel="stylesheet" href="fptools.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="The Parallel Haskell Compilation System User's Guide, Version 7.4.2"><link rel="up" href="index.html" title="The Parallel Haskell Compilation System User's Guide, Version 7.4.2"><link rel="prev" href="ffi-ghc.html" title="8.2. Using the FFI with GHC"><link rel="next" href="ghc-as-a-library.html" title="9.2. Using GHC as a Library"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 9. Extending and using GHC as a Library</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ffi-ghc.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ghc-as-a-library.html">Next</a></td></tr></table><hr></div><div class="chapter" title="Chapter 9. Extending and using GHC as a Library"><div class="titlepage"><div><div><h2 class="title"><a name="extending-ghc"></a>Chapter 9. Extending and using GHC as a Library</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="extending-ghc.html#annotation-pragmas">9.1. Source annotations</a></span></dt><dd><dl><dt><span class="sect2"><a href="extending-ghc.html#ann-pragma">9.1.1. Annotating values</a></span></dt><dt><span class="sect2"><a href="extending-ghc.html#typeann-pragma">9.1.2. Annotating types</a></span></dt><dt><span class="sect2"><a href="extending-ghc.html#modann-pragma">9.1.3. Annotating modules</a></span></dt></dl></dd><dt><span class="sect1"><a href="ghc-as-a-library.html">9.2. Using GHC as a Library</a></span></dt><dt><span class="sect1"><a href="compiler-plugins.html">9.3. Compiler Plugins</a></span></dt><dd><dl><dt><span class="sect2"><a href="compiler-plugins.html#using-compiler-plugins">9.3.1. Using compiler plugins</a></span></dt><dt><span class="sect2"><a href="compiler-plugins.html#writing-compiler-plugins">9.3.2. Writing compiler plugins</a></span></dt><dd><dl><dt><span class="sect3"><a href="compiler-plugins.html#coretodo-in-more-detail">9.3.2.1. <code class="literal">CoreToDo</code> in more detail</a></span></dt><dt><span class="sect3"><a href="compiler-plugins.html#manipulating-bindings">9.3.2.2. Manipulating bindings</a></span></dt><dt><span class="sect3"><a href="compiler-plugins.html#getting-annotations">9.3.2.3. Using Annotations</a></span></dt></dl></dd></dl></dd></dl></div><p>GHC exposes its internal APIs to users through the built-in ghc package. It allows you to write programs that leverage GHC's entire compilation driver, in order to analyze or compile Haskell code programmatically. Furthermore, GHC gives users the ability to load compiler plugins during compilation - modules which are allowed to view and change GHC's internal intermediate representation, Core. Plugins are suitable for things like experimental optimizations or analysis, and offer a lower barrier of entry to compiler development for many common cases.</p><p>Furthermore, GHC offers a lightweight annotation mechanism that you can use to annotate your source code with metadata, which you can later inspect with either the compiler API or a compiler plugin.</p><div class="sect1" title="9.1. Source annotations"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="annotation-pragmas"></a>9.1. Source annotations</h2></div></div></div><p>Annotations are small pragmas that allow you to attach data to identifiers in source code, which are persisted when compiled. These pieces of data can then inspected and utilized when using GHC as a library or writing a compiler plugin.</p><div class="sect2" title="9.1.1. Annotating values"><div class="titlepage"><div><div><h3 class="title"><a name="ann-pragma"></a>9.1.1. Annotating values</h3></div></div></div><a class="indexterm" name="idp33225592"></a><p>Any expression that has both <code class="literal">Typeable</code> and <code class="literal">Data</code> instances may be attached to a top-level value
      binding using an <code class="literal">ANN</code> pragma. In particular, this means you can use <code class="literal">ANN</code>
      to annotate data constructors (e.g. <code class="literal">Just</code>) as well as normal values (e.g. <code class="literal">take</code>).
      By way of example, to annotate the function <code class="literal">foo</code> with the annotation <code class="literal">Just "Hello"</code>
      you would do this:</p><pre class="programlisting">
{-# ANN foo (Just "Hello") #-}
foo = ...
</pre><p>
        A number of restrictions apply to use of annotations:
        </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>The binder being annotated must be at the top level (i.e. no nested binders)</p></li><li class="listitem"><p>The binder being annotated must be declared in the current module</p></li><li class="listitem"><p>The expression you are annotating with must have a type with <code class="literal">Typeable</code> and <code class="literal">Data</code> instances</p></li><li class="listitem"><p>The <a class="ulink" href="" target="_top">Template Haskell staging restrictions</a> apply to the
          expression being annotated with, so for example you cannot run a function from the module being compiled.</p><p>To be precise, the annotation <code class="literal">{-# ANN x e #-}</code> is well staged if and only if <code class="literal">$(e)</code> would be
          (disregarding the usual type restrictions of the splice syntax, and the usual restriction on splicing inside a splice - <code class="literal">$([|1|])</code> is fine as an annotation, albeit redundant).</p></li></ul></div><p>

        If you feel strongly that any of these restrictions are too onerous, <a class="ulink" href="http://hackage.haskell.org/trac/ghc/wiki/MailingListsAndIRC" target="_top">
        please give the GHC team a shout</a>.
      </p><p>However, apart from these restrictions, many things are allowed, including expressions which are not fully evaluated!
      Annotation expressions will be evaluated by the compiler just like Template Haskell splices are. So, this annotation is fine:</p><pre class="programlisting">
{-# ANN f SillyAnnotation { foo = (id 10) + $([| 20 |]), bar = 'f } #-}
f = ...
</pre></div><div class="sect2" title="9.1.2. Annotating types"><div class="titlepage"><div><div><h3 class="title"><a name="typeann-pragma"></a>9.1.2. Annotating types</h3></div></div></div><a class="indexterm" name="idp33256232"></a><a class="indexterm" name="idp33256640"></a><p>You can annotate types with the <code class="literal">ANN</code> pragma by using the <code class="literal">type</code> keyword. For example:</p><pre class="programlisting">
{-# ANN type Foo (Just "A `Maybe String' annotation") #-}
data Foo = ...
</pre></div><div class="sect2" title="9.1.3. Annotating modules"><div class="titlepage"><div><div><h3 class="title"><a name="modann-pragma"></a>9.1.3. Annotating modules</h3></div></div></div><a class="indexterm" name="idp33259048"></a><a class="indexterm" name="idp33259456"></a><p>You can annotate modules with the <code class="literal">ANN</code> pragma by using the <code class="literal">module</code> keyword. For example:</p><pre class="programlisting">
{-# ANN module (Just "A `Maybe String' annotation") #-}
</pre></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ffi-ghc.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ghc-as-a-library.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">8.2. Using the FFI with GHC </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 9.2. Using GHC as a Library</td></tr></table></div></body></html>
